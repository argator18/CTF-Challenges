import hlextend
import pwn
import base64
from hashlib import sha1

host = "5689d9be78daa08d905367dd-1024-intro-crypto-2.challenge.cscg.live"
port = 1337

def decode_base64(data):
    try:
        # Strip any whitespace and decode
        decoded_bytes = base64.b64decode(data.strip())
        return decoded_bytes.decode('utf-8')
    except (base64.binascii.Error, UnicodeDecodeError) as e:
        print("An error occurred:", e)
        return None


sha = hlextend.new('sha1')
#p = pwn.process("main.py")
p = pwn.remote(host,port,ssl=True)
p.sendlineafter(b"choice: ",b"1")
p.sendlineafter(b"name? ",b"Len")
p.sendlineafter(b"animal? ",b"Lion")
access_token=p.recvline().split(b': ')[1]
access_token = decode_base64(access_token.decode('utf-8'))
mac = access_token.split("|")[-1]
token = access_token.split(mac)[0][:-1]
mac = access_token.split("mac=")[1]
extended = sha.extend(b'|admin=true', token.encode(), 32, mac)
sha_extended = sha.hexdigest()
p.sendlineafter(b"choice: ",b"3")
secure_token = extended + b"|mac="+sha_extended.encode()

p.sendlineafter(b"token: ",base64.b64encode(secure_token))
print(p.recvall(1))
